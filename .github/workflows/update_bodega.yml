name: Update Bodega Formula

on:
  schedule:
    - cron: '0 0 * * *' # Runs daily at midnight UTC
  workflow_dispatch: # Allow manual triggering of the workflow

jobs:
  update-formula:
    name: Check and Update Bodega Formula
    runs-on: ubuntu-slim
    permissions:
      contents: write
      pull-requests: write

    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Fetch the latest release of bodega
      - name: Get latest release
        id: get_latest_release
        run: |
          latest_release=$(curl --silent "https://api.github.com/repos/bjia56/bodega/releases/latest" | jq -r .tag_name)
          echo "Latest release: $latest_release"
          echo "latest_release=$latest_release" >> $GITHUB_ENV

      # Download all platform-specific artifacts and calculate sha256 checksums
      - name: Calculate sha256 checksums
        id: calculate_checksums
        run: |
          base_url="https://github.com/bjia56/bodega/releases/download/${{ env.latest_release }}"

          # Download and calculate checksum for macOS x86_64
          curl -L -o bodega-macos-x86_64 "$base_url/bodega-macos-x86_64"
          sha256_macos_x86_64=$(shasum -a 256 bodega-macos-x86_64 | awk '{print $1}')
          echo "macOS x86_64 SHA256: $sha256_macos_x86_64"
          echo "sha256_macos_x86_64=$sha256_macos_x86_64" >> $GITHUB_ENV
          rm bodega-macos-x86_64

          # Download and calculate checksum for macOS ARM64
          curl -L -o bodega-macos-arm64 "$base_url/bodega-macos-arm64"
          sha256_macos_arm64=$(shasum -a 256 bodega-macos-arm64 | awk '{print $1}')
          echo "macOS ARM64 SHA256: $sha256_macos_arm64"
          echo "sha256_macos_arm64=$sha256_macos_arm64" >> $GITHUB_ENV
          rm bodega-macos-arm64

          # Download and calculate checksum for Linux x86_64
          curl -L -o bodega-linux-x86_64 "$base_url/bodega-linux-x86_64"
          sha256_linux_x86_64=$(shasum -a 256 bodega-linux-x86_64 | awk '{print $1}')
          echo "Linux x86_64 SHA256: $sha256_linux_x86_64"
          echo "sha256_linux_x86_64=$sha256_linux_x86_64" >> $GITHUB_ENV
          rm bodega-linux-x86_64

          # Download and calculate checksum for Linux ARM64
          curl -L -o bodega-linux-arm64 "$base_url/bodega-linux-arm64"
          sha256_linux_arm64=$(shasum -a 256 bodega-linux-arm64 | awk '{print $1}')
          echo "Linux ARM64 SHA256: $sha256_linux_arm64"
          echo "sha256_linux_arm64=$sha256_linux_arm64" >> $GITHUB_ENV
          rm bodega-linux-arm64

      # Update the formula file
      - name: Update formula
        run: |
          latest_release="${{ env.latest_release }}"
          sha256_macos_x86_64="${{ env.sha256_macos_x86_64 }}"
          sha256_macos_arm64="${{ env.sha256_macos_arm64 }}"
          sha256_linux_x86_64="${{ env.sha256_linux_x86_64 }}"
          sha256_linux_arm64="${{ env.sha256_linux_arm64 }}"
          formula_file="Formula/bodega.rb"

          if [[ ! -f "$formula_file" ]]; then
            echo "Formula file not found!"
            exit 1
          fi

          # Update version
          sed -i "s/^  version \".*\"/  version \"$latest_release\"/" "$formula_file"

          # Update SHA256 checksums for each platform
          # macOS x86_64
          sed -i "0,/sha256 \".*\"/s//sha256 \"$sha256_macos_x86_64\"/" "$formula_file"
          # macOS ARM64
          sed -i "0,/sha256 \".*\"/s//sha256 \"$sha256_macos_arm64\"/" "$formula_file"
          # Linux x86_64
          sed -i "0,/sha256 \".*\"/s//sha256 \"$sha256_linux_x86_64\"/" "$formula_file"
          # Linux ARM64
          sed -i "0,/sha256 \".*\"/s//sha256 \"$sha256_linux_arm64\"/" "$formula_file"

      # Create a pull request
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          committer: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          author: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          commit-message: "Update bodega formula to ${{ env.latest_release }}"
          title: "Update bodega formula to ${{ env.latest_release }}"
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: update-bodega-formula
          delete-branch: true
          body: |
            This PR updates the `bodega` formula to the latest release: `${{ env.latest_release }}`.

            **Version**: `${{ env.latest_release }}`

            **SHA256 Checksums**:
            - macOS x86_64: `${{ env.sha256_macos_x86_64 }}`
            - macOS ARM64: `${{ env.sha256_macos_arm64 }}`
            - Linux x86_64: `${{ env.sha256_linux_x86_64 }}`
            - Linux ARM64: `${{ env.sha256_linux_arm64 }}`
